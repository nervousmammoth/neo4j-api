---
**Status:** To Do
**Priority:** P1
**Branch:** `feature/P1.2-Query-Endpoint-Basic`
---

## Overview

Implement `POST /api/{database}/graph/query` endpoint in `app/routers/query.py` for Cypher query execution. This implements basic functionality without validation (validation added in Issue P1.3).

**Phase:** 3 - Query Execution

## Related Specifications
- [ ] **Spec file:** `specs/endpoints-query.md` - Complete specification
- [ ] **Spec file:** `specs/data-models.md` - Query models

## Related BDD Tests
- [ ] **Feature file:** `features/query.feature`
- [ ] **Scenarios:** Basic query execution scenarios (not validation)
- [ ] **Tags:** `@query`

## Dependencies
- [ ] Issue P0.5 - Neo4j client
- [ ] Issue P0.8 - API key auth
- [ ] Issue P1.1 - Query models

---

## TDD Workflow Checklist

### 1️⃣ RED - Write Failing Tests
- [ ] Create: `tests/test_query.py`
- [ ] Write unit tests for POST /api/{database}/graph/query
  - [ ] Test successful query execution
  - [ ] Test with parameters
  - [ ] Test with different database
  - [ ] Test requires authentication
  - [ ] Test error handling
  - [ ] Test execution time tracking
- [ ] Run tests: `pytest tests/test_query.py -v`
- [ ] **Verify tests FAIL** ❌

### 2️⃣ GREEN - Implement Minimum Code
- [ ] Create: `app/routers/query.py`
- [ ] Implement router and endpoint
- [ ] Execute query via Neo4j client
- [ ] Track execution time
- [ ] Format response
- [ ] Register router in app/main.py
- [ ] Run tests: `pytest tests/test_query.py -v`
- [ ] **Verify tests PASS** ✅

### 3️⃣ REFACTOR
- [ ] Run black, ruff, mypy
- [ ] **Verify tests still pass** ✅

### 4️⃣ BDD Validation
- [ ] Run: `behave features/query.feature --tags=@query,-@validation -v`
- [ ] **Verify basic query scenarios pass** ✅

### 5️⃣ Coverage Check
- [ ] Run coverage
- [ ] **Verify 100% coverage** ✅

---

## Acceptance Criteria

### Functional Requirements
- [ ] POST /api/{database}/graph/query endpoint implemented
- [ ] Accepts QueryRequest body
- [ ] Executes Cypher query via Neo4j client
- [ ] Returns QueryResponse with results
- [ ] Tracks execution time
- [ ] Supports parameterized queries
- [ ] Supports multi-database via path parameter
- [ ] Requires authentication

### Non-Functional Requirements
- [ ] Unit tests with 100% coverage
- [ ] BDD scenarios pass (basic queries)
- [ ] Type hints, formatting, linting

---

## Implementation Notes

### Example Code

**app/routers/query.py:**
```python
"""Cypher query execution endpoint."""

from __future__ import annotations

import time

from fastapi import APIRouter, Depends, HTTPException, Path
from neo4j.exceptions import Neo4jError

from app.dependencies import get_neo4j_client, verify_api_key
from app.models import QueryRequest, QueryResponse
from app.utils.neo4j_client import Neo4jClient

router = APIRouter(
    prefix="/api/{database}/graph",
    tags=["query"],
    dependencies=[Depends(verify_api_key)],  # Requires authentication
)

@router.post("/query", response_model=QueryResponse)
async def execute_query(
    database: str = Path(..., description="Database name"),
    request: QueryRequest = ...,
    client: Neo4jClient = Depends(get_neo4j_client),
) -> QueryResponse:
    """Execute a Cypher query.

    Args:
        database: Target database name.
        request: Query request with query string and parameters.
        client: Neo4j client instance.

    Returns:
        Query results with execution metadata.

    Raises:
        HTTPException: If query execution fails.
    """
    try:
        start_time = time.time()

        results = client.execute_query(
            query=request.query,
            parameters=request.parameters,
            database=database,
        )

        execution_time_ms = (time.time() - start_time) * 1000

        return QueryResponse(
            results=results,
            count=len(results),
            execution_time_ms=round(execution_time_ms, 2),
        )

    except Neo4jError as e:
        raise HTTPException(
            status_code=400,
            detail=f"Query execution failed: {str(e)}",
        )
```

**app/main.py additions:**
```python
from app.routers import health, query

app.include_router(query.router)
```

---

## Git Workflow

```bash
git checkout main
git pull origin main
git checkout -b feature/P1.2-query-endpoint-basic

# TDD cycle
pytest tests/test_query.py -v

# Implement
# Refactor
black app/ tests/
ruff check app/ tests/ --fix
mypy app/

# BDD validation (basic queries only)
behave features/query.feature --tags=@query,-@validation -v

# Commit
git add app/routers/query.py app/main.py tests/test_query.py
git commit -m "feat(P1.2): implement basic query execution endpoint"
git push origin feature/P1.2-query-endpoint-basic
```

---

## Verification Commands

```bash
pytest tests/test_query.py -v
behave features/query.feature --tags=@query,-@validation -v

# Test manually
curl -X POST http://localhost:8000/api/neo4j/graph/query \
  -H "X-API-Key: your-key" \
  -H "Content-Type: application/json" \
  -d '{"query": "MATCH (n) RETURN n LIMIT 5"}'
```

---

## References
- **Specification:** `specs/endpoints-query.md`
- **BDD Feature:** `features/query.feature`

---

## Notes
- Query validation will be added in Issue P1.3
- This issue implements basic query execution only
- Authentication is required for this endpoint
- Execution time tracking is important for monitoring
