---
**Status:** To Do
**Priority:** P1
**Branch:** `feature/P1.5-Standardize-Error-Format`
---

## Overview

Standardize Error Response Format
**Phase:** Code Quality

Error responses across the API have inconsistent structure. The `details` field is sometimes included and sometimes omitted:
- `dependencies.py`: includes `details` with header info (`{"header": "X-API-Key"}`)
- `health.py`: sometimes includes `details`, sometimes omits it

This inconsistency makes it harder for API clients to parse error responses reliably.

## Related Specifications
- `specs/error-handling.md` - Error response format
- `specs/data-models.md` - ErrorResponse model

## Dependencies
- None - Can be done independently

---

## TDD Workflow Checklist

### 1ï¸âƒ£ RED - Write Failing Tests
- [ ] Review existing tests in `tests/test_dependencies.py` and `tests/test_health.py`
- [ ] Add/update tests to verify consistent `details` field presence
- [ ] Test case: Error response always has `details` key
- [ ] Test case: `details` can be empty dict `{}` when no extra info
- [ ] Run tests: `pytest tests/test_dependencies.py tests/test_health.py -v`
- [ ] **Verify tests FAIL** âŒ

### 2ï¸âƒ£ GREEN - Implement Consistent Format
- [ ] Update `app/models.py` - Ensure ErrorDetail model has `details` field
- [ ] Update `app/dependencies.py` - Always include `details`
- [ ] Update `app/routers/health.py` - Always include `details` (can be `{}`)
- [ ] Run tests: `pytest tests/test_dependencies.py tests/test_health.py -v`
- [ ] **Verify tests PASS** âœ…

### 3ï¸âƒ£ REFACTOR - Improve Code Quality
- [ ] Run black: `black app/ tests/`
- [ ] Run ruff: `ruff check app/ tests/ --fix`
- [ ] Run mypy: `mypy app/`
- [ ] **Verify tests still pass** âœ…

### 4ï¸âƒ£ Coverage Check
- [ ] Run coverage: `pytest --cov=app --cov-report=term-missing --cov-report=html`
- [ ] **Verify 100% coverage** âœ…

---

## Acceptance Criteria

### Functional Requirements
- [ ] All error responses include `details` field
- [ ] `details` field is always a dict (can be empty `{}`)
- [ ] Existing functionality preserved (no breaking changes to error info)

### Non-Functional Requirements
- [ ] Unit tests updated to verify consistent format
- [ ] 100% code coverage maintained
- [ ] Type hints present (mypy compliant)
- [ ] Code formatted (black)
- [ ] Linting passed (ruff)

### Code Quality Gates
- [ ] Pre-commit hooks pass
- [ ] All pytest tests pass
- [ ] Coverage >= 100%

---

## Implementation Notes

### Files to Modify
```
app/models.py
app/dependencies.py
app/routers/health.py
tests/test_dependencies.py
tests/test_health.py
```

### Current Inconsistency Examples

**dependencies.py (line ~45):**
```python
# Has details
raise HTTPException(
    status_code=403,
    detail={
        "error": {
            "code": "MISSING_API_KEY",
            "message": "API key is required",
            "details": {"header": "X-API-Key"}
        }
    }
)
```

**health.py (line ~60):**
```python
# Missing details
return JSONResponse(
    status_code=503,
    content={
        "error": {
            "code": "SERVICE_UNAVAILABLE",
            "message": "Neo4j is not available"
            # No "details" key!
        }
    }
)
```

### Target Format (Consistent)
```python
{
    "error": {
        "code": "ERROR_CODE",
        "message": "Human readable message",
        "details": {}  # Always present, can be empty
    }
}
```

---

## Git Workflow

### Start Issue
```bash
git checkout main
git pull origin main
git checkout -b feature/P1.5-standardize-error-format
```

### During Development
```bash
git add .
git commit -m "fix(P1.5): standardize error response format with details field"
git push origin feature/P1.5-standardize-error-format
```

### Create Pull Request
```bash
gh pr create \
  --title "fix: standardize error response format" \
  --body "$(cat <<'EOF'
## Summary
- Ensures all error responses include `details` field
- Standardizes error format across dependencies and routers

## Changes
- `app/models.py`: Ensure ErrorDetail model consistency
- `app/dependencies.py`: Include `details` in all errors
- `app/routers/health.py`: Include `details` in all errors
- `tests/`: Update tests to verify consistent format

## Testing
- [x] Unit tests pass (pytest)
- [x] 100% coverage achieved
- [x] Pre-commit hooks pass

## Closes
Closes #38

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
EOF
)"
```

### After Merge
```bash
mv issues/P1.5-standardize-error-format.md issues/completed/
git checkout main
git pull origin main
```

---

## Verification Commands

```bash
# Run relevant tests
pytest tests/test_dependencies.py tests/test_health.py -v

# Run with coverage
pytest --cov=app --cov-report=term-missing

# Run all quality checks
pre-commit run --all-files
```

---

## Notes
This is a minor API contract change but improves consistency. API clients can now reliably expect `error.details` to always be present.
