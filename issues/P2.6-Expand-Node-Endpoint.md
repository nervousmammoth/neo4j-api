---
**Status:** To Do
**Priority:** P2
**Branch:** `feature/P2.6-Expand-Node-Endpoint`
---

## Overview

Implement Expand Node Neighborhood Endpoint
**Phase:** 5 - Node Operations

Implement `POST /api/{database}/graph/nodes/expand` endpoint to retrieve node neighborhoods (connected nodes and relationships).

## User Story

**As an** API consumer
**I want** to retrieve a node's neighborhood (connected nodes and edges) with configurable direction and depth
**So that** I can visualize graph relationships and explore how nodes are connected

## Related Specifications
- [ ] **Spec file:** `specs/endpoints-nodes.md` - Section 2 (Expand Neighborhood)

## Related BDD Tests
- [ ] **Feature file:** `features/nodes.feature`
- [ ] **Tags:** `@nodes`, `@expand`

## Dependencies
- [ ] Issue P2.4 - Node models (ExpandRequest/Response)

---

## TDD Workflow Checklist

### 1️⃣ RED - Write Failing Tests
- [ ] Add to: `tests/test_nodes.py`
- [ ] Write tests for POST /api/{database}/graph/nodes/expand
- [ ] **Verify tests FAIL** ❌

### 2️⃣ GREEN - Implement
- [ ] Add to: `app/routers/nodes.py`
- [ ] Implement expand endpoint with direction/depth
- [ ] **Verify tests PASS** ✅

### 3️⃣ REFACTOR & BDD
- [ ] Run black, ruff, mypy
- [ ] Run: `behave features/nodes.feature --tags=@expand -v`
- [ ] **Verify 100% coverage** ✅

---

## Acceptance Criteria

### Functional Requirements
- [ ] POST /api/{database}/graph/nodes/expand endpoint
- [ ] Accepts ExpandRequest body
- [ ] Supports direction (in/out/both)
- [ ] Supports max_depth (1-3)
- [ ] Returns nodes and edges in neighborhood
- [ ] Requires authentication

---

## Implementation Notes

```python
@router.post("/nodes/expand", response_model=ExpandResponse)
async def expand_nodes(
    database: str = Path(...),
    request: ExpandRequest = ...,
    client: Neo4jClient = Depends(get_neo4j_client),
) -> ExpandResponse:
    """Expand node neighborhoods."""

    # Build direction pattern
    if request.direction == "in":
        pattern = "<-[r]-"
    elif request.direction == "out":
        pattern = "-[r]->"
    else:  # both
        pattern = "-[r]-"

    # Build Cypher query
    query = f"""
    MATCH (start)
    WHERE id(start) IN $node_ids
    MATCH (start){pattern}(neighbor)
    RETURN start, r, neighbor
    """

    results = client.execute_query(
        query=query,
        parameters={"node_ids": [int(nid) for nid in request.node_ids]},
        database=database,
    )

    # Process results
    nodes_dict = {}
    edges = []

    for record in results:
        # Add nodes
        for key in ["start", "neighbor"]:
            if key in record:
                node_data = record[key]
                node_id = str(node_data.id)
                if node_id not in nodes_dict:
                    nodes_dict[node_id] = Node(
                        id=node_id,
                        categories=list(node_data.labels),
                        properties=dict(node_data),
                    )

        # Add edge
        if "r" in record:
            edge_data = record["r"]
            edges.append(
                Edge(
                    id=str(edge_data.id),
                    type=edge_data.type,
                    source=str(record["start"].id),
                    target=str(record["neighbor"].id),
                    properties=dict(edge_data),
                )
            )

    nodes = list(nodes_dict.values())

    return ExpandResponse(nodes=nodes, edges=edges, count=len(nodes))
```

---

## Git Workflow

```bash
git checkout main && git pull origin main
git checkout -b feature/P2.6-expand-node-endpoint

# TDD, implement, test
pytest tests/test_nodes.py::test_expand* -v
behave features/nodes.feature --tags=@expand -v

# Commit
git add app/routers/nodes.py tests/test_nodes.py
git commit -m "feat(P2.6): implement expand node neighborhood endpoint"
git push origin feature/P2.6-expand-node-endpoint
```

---

## References
- **Specification:** `specs/endpoints-nodes.md` - Section 2
