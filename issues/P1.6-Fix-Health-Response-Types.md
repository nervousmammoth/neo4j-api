---
**Status:** To Do
**Priority:** P1
**Branch:** `feature/P1.6-Fix-Health-Response-Types`
---

## Overview

Fix Health Endpoint Response Types
**Phase:** Code Quality

The health endpoint's `_unhealthy_response()` helper returns `JSONResponse` instead of `HealthResponse` model for 503 status. This breaks the OpenAPI documentation contract - clients expecting `HealthResponse` structure may fail when the service is unhealthy.

The endpoint should use the proper response model with FastAPI's status code handling, not raw `JSONResponse`.

## Related Specifications
- `specs/endpoints-health.md` - Health endpoint specification
- `specs/data-models.md` - HealthResponse model

## Dependencies
- [ ] Issue #38 - Error format standardization (recommended to do first for consistent error handling)

---

## TDD Workflow Checklist

### 1ï¸âƒ£ RED - Write Failing Tests
- [ ] Review existing tests in `tests/test_health.py`
- [ ] Add tests that verify response model compliance for 503 status
- [ ] Test case: Unhealthy response has `status`, `timestamp`, `version`, `database` fields
- [ ] Test case: Response validates against HealthResponse model
- [ ] Run tests: `pytest tests/test_health.py -v`
- [ ] **Verify tests FAIL** âŒ

### 2ï¸âƒ£ GREEN - Fix Response Types
- [ ] Update `app/routers/health.py`
- [ ] Replace `JSONResponse` with proper `HealthResponse` model
- [ ] Use FastAPI `Response` parameter for status code control
- [ ] Run tests: `pytest tests/test_health.py -v`
- [ ] **Verify tests PASS** âœ…

### 3ï¸âƒ£ REFACTOR - Improve Code Quality
- [ ] Run black: `black app/ tests/`
- [ ] Run ruff: `ruff check app/ tests/ --fix`
- [ ] Run mypy: `mypy app/`
- [ ] **Verify tests still pass** âœ…

### 4ï¸âƒ£ Coverage Check
- [ ] Run coverage: `pytest --cov=app --cov-report=term-missing --cov-report=html`
- [ ] **Verify 100% coverage** âœ…

---

## Acceptance Criteria

### Functional Requirements
- [ ] Health endpoint returns `HealthResponse` model for all status codes (200, 503)
- [ ] OpenAPI docs correctly reflect response types
- [ ] 503 responses still include proper error information

### Non-Functional Requirements
- [ ] Unit tests verify response model structure
- [ ] 100% code coverage maintained
- [ ] Type hints present (mypy compliant)
- [ ] Code formatted (black)
- [ ] Linting passed (ruff)

### Code Quality Gates
- [ ] Pre-commit hooks pass
- [ ] All pytest tests pass
- [ ] Coverage >= 100%

---

## Implementation Notes

### Files to Modify
```
app/routers/health.py
tests/test_health.py
```

### Current Implementation (problematic)
```python
# app/routers/health.py lines 55-65
def _unhealthy_response(error_msg: str) -> JSONResponse:
    return JSONResponse(
        status_code=503,
        content={
            "status": "unhealthy",
            "timestamp": datetime.now(UTC).isoformat(),
            # ... other fields
        }
    )
```

### Target Implementation (fixed)
```python
from fastapi import Response

@router.get("/health", response_model=HealthResponse)
async def health_check(response: Response) -> HealthResponse:
    try:
        # ... check health
        if not healthy:
            response.status_code = 503
            return HealthResponse(
                status="unhealthy",
                timestamp=datetime.now(UTC).isoformat(),
                # ... other fields
            )
        return HealthResponse(
            status="healthy",
            # ... other fields
        )
    except Exception:
        response.status_code = 503
        return HealthResponse(...)
```

### Alternative: Use responses parameter
```python
@router.get(
    "/health",
    response_model=HealthResponse,
    responses={
        200: {"model": HealthResponse},
        503: {"model": HealthResponse}
    }
)
```

---

## Git Workflow

### Start Issue
```bash
git checkout main
git pull origin main
git checkout -b feature/P1.6-fix-health-response-types
```

### During Development
```bash
git add .
git commit -m "fix(P1.6): return proper HealthResponse model for all status codes"
git push origin feature/P1.6-fix-health-response-types
```

### Create Pull Request
```bash
gh pr create \
  --title "fix: return proper response models from health endpoint" \
  --body "$(cat <<'EOF'
## Summary
- Health endpoint now returns HealthResponse model for all status codes
- Fixes OpenAPI documentation contract violation

## Changes
- `app/routers/health.py`: Use HealthResponse model with Response status code
- `tests/test_health.py`: Verify response model compliance

## Testing
- [x] Unit tests pass (pytest)
- [x] 100% coverage achieved
- [x] Pre-commit hooks pass

## Closes
Closes #39

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
EOF
)"
```

### After Merge
```bash
mv issues/P1.6-fix-health-response-types.md issues/completed/
git checkout main
git pull origin main
```

---

## Verification Commands

```bash
# Run health tests
pytest tests/test_health.py -v

# Run with coverage
pytest --cov=app --cov-report=term-missing

# Verify OpenAPI docs
# Start server and check /api/docs
uvicorn app.main:app --reload
# Navigate to http://localhost:8000/api/docs and verify health endpoint response schema

# Run all quality checks
pre-commit run --all-files
```

---

## Notes
This fix ensures proper OpenAPI contract compliance. API clients using code generation (like OpenAPI Generator) will get correct type definitions for both success and error cases.
