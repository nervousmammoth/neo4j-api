---
**Status:** To Do
**Priority:** P4
**Branch:** `feature/P4.5-Integration-Tests-Docker`
---

## Overview

Integration Tests with Docker Neo4j
**Phase:** Infrastructure

Configure integration tests to run with a Docker Neo4j container. Fix pre-push hook to exclude integration tests (unit tests should run without external dependencies). Document workflow for running integration tests locally.

## Dependencies
- [x] Issue P0.10 - Health check endpoint (already implemented)
- [x] `docker-compose.test.yml` already exists
- [x] `tests/integration/` tests already exist

---

## Current State

### Already In Place ✅
| Component | Status | Details |
|-----------|--------|---------|
| `docker-compose.test.yml` | ✅ Ready | Neo4j 5-community on port 7691 |
| `tests/integration/test_neo4j_connection.py` | ✅ Ready | 7 integration tests with `@pytest.mark.integration` |
| `.env.test` | ✅ Ready | Test environment configuration |

### Needs Fixing ⚠️
| Component | Issue | Fix |
|-----------|-------|-----|
| `scripts/pre-push.template` | Runs integration tests | Add `--ignore=tests/integration` (DONE) |
| `.git/hooks/pre-push` | Uses old template | Reinstall hooks |
| `pyproject.toml` | Missing marker registration | Register `integration` marker |

---

## TDD Workflow Checklist

### 1️⃣ Fix Pre-push Hook
- [x] Update `scripts/pre-push.template` to exclude integration tests
- [ ] Run `./scripts/setup_hooks.sh` to reinstall hooks
- [ ] Verify pre-push runs only unit tests

### 2️⃣ Register pytest Markers
- [ ] Add `integration` marker to `pyproject.toml` to avoid warnings:
  ```toml
  [tool.pytest.ini_options]
  markers = [
      "integration: Integration tests requiring external services (Neo4j)",
  ]
  ```

### 3️⃣ Verify Docker Integration Tests
- [ ] Start Neo4j container: `docker compose -f docker-compose.test.yml up -d --wait`
- [ ] Verify connectivity with `driver.verify_connectivity()` pattern
- [ ] Run integration tests: `pytest tests/integration/ -v -m integration`
- [ ] Verify all 7 integration tests pass
- [ ] Stop container: `docker compose -f docker-compose.test.yml down`

### 4️⃣ Update Documentation
- [ ] Add integration test instructions to CLAUDE.md
- [ ] Document Docker requirements

---

## Acceptance Criteria

### Functional Requirements
- [ ] Pre-push hook excludes `tests/integration/` directory
- [ ] Unit tests pass without Docker/Neo4j running
- [ ] Integration tests pass when Docker Neo4j is running
- [ ] `git push` succeeds without `--no-verify`
- [ ] No pytest marker warnings for `@pytest.mark.integration`

### Non-Functional Requirements
- [ ] Clear documentation for running integration tests
- [ ] Pre-push hook runs in < 30 seconds (unit tests only)

---

## Implementation Notes

### Files to Modify
```
scripts/pre-push.template  # Add --ignore=tests/integration (DONE)
pyproject.toml             # Register integration marker
CLAUDE.md                  # Add integration test documentation
```

### Integration Test Workflow

**Start Test Database:**
```bash
docker compose -f docker-compose.test.yml up -d --wait
```

**Run Integration Tests:**
```bash
# Run all integration tests
pytest tests/integration/ -v -m integration

# Run only integration tests, exclude unit tests
pytest -m integration -v

# Run everything except integration tests (default for CI)
pytest -m "not integration" -v
```

**Stop Test Database:**
```bash
docker compose -f docker-compose.test.yml down
```

**Full Cleanup (remove volumes):**
```bash
docker compose -f docker-compose.test.yml down -v
```

### Test Database Configuration
| Setting | Value |
|---------|-------|
| Image | `neo4j:5-community` |
| Bolt Port | `7691` (unique to avoid conflicts) |
| HTTP Port | `7478` |
| Username | `neo4j` |
| Password | `testpassword` |
| Plugins | APOC |

### Neo4j Driver Best Practices (from docs)
```python
from neo4j import GraphDatabase, DriverError, Neo4jError

# Recommended: Use context manager for automatic cleanup
with GraphDatabase.driver(uri, auth=(user, password)) as driver:
    driver.verify_connectivity()  # Health check before queries
    # ... use driver
```

### pytest-docker Alternative (Optional Enhancement)
The `pytest-docker` plugin can automate container lifecycle:
```python
@pytest.fixture(scope="session")
def docker_compose_file(pytestconfig):
    return os.path.join(str(pytestconfig.rootdir), "docker-compose.test.yml")

@pytest.fixture(scope="session")
def neo4j_service(docker_ip, docker_services):
    port = docker_services.port_for("neo4j", 7687)
    url = f"bolt://{docker_ip}:{port}"
    docker_services.wait_until_responsive(
        timeout=60.0, pause=1.0,
        check=lambda: is_neo4j_responsive(url)
    )
    return url
```

---

## Git Workflow

### Start Issue
```bash
git checkout main
git pull origin main
git checkout -b feature/P4.5-integration-tests-docker
```

### Reinstall Hooks
```bash
./scripts/setup_hooks.sh
```

### Test Pre-push
```bash
# Should pass without Docker running
git push origin feature/P4.5-integration-tests-docker
```

---

## Verification Commands

```bash
# Verify pre-push excludes integration tests
grep -A5 "pytest tests/" scripts/pre-push.template

# Run unit tests only (should pass without Docker)
pytest tests/ --ignore=tests/integration -v

# Alternative: use marker expression
pytest -m "not integration" -v

# Start Docker and run integration tests
docker compose -f docker-compose.test.yml up -d --wait
pytest tests/integration/ -v -m integration
docker compose -f docker-compose.test.yml down
```

---

## References
- **pytest markers:** https://docs.pytest.org/en/stable/example/markers.html
- **pytest-docker plugin:** https://github.com/avast/pytest-docker
- **Neo4j Python Driver:** https://neo4j.com/docs/python-manual/current/

---

## Notes
- Integration tests require Docker Desktop or Docker Engine
- Neo4j container takes ~30 seconds to fully start (healthcheck configured)
- Use unique ports (7691, 7478) to avoid conflicts with local Neo4j installations
- The `--wait` flag ensures container is healthy before tests run
- Consider `pytest-docker` plugin for future automation of container lifecycle
