---
**Status:** To Do
**Priority:** P4
**Branch:** `feature/P4.2-Caddyfile-Config`
---

## Overview

Create Caddyfile for Reverse Proxy
**Phase:** 8 - Deployment

Create `Caddyfile` configuration for Caddy reverse proxy. Caddy handles HTTPS, rate limiting, and proxies requests from port 80/443 to FastAPI on port 8000.

## Related Specifications
- [ ] **Reference:** `CLAUDE.md` - Production Deployment section

## Related BDD Tests
N/A - Configuration file

## Dependencies
- [ ] All application code complete (Phase 1-7)

---

## Workflow Checklist

### 1ï¸âƒ£ Research & Planning
- [ ] Review Caddy documentation
- [ ] Review production requirements
- [ ] Plan Caddyfile structure

### 2ï¸âƒ£ Create Caddyfile
- [ ] Create `/etc/caddy/Caddyfile` template
- [ ] Configure reverse proxy to :8000
- [ ] Configure HTTPS/TLS
- [ ] Configure rate limiting
- [ ] Configure logging
- [ ] Configure error handling

### 3ï¸âƒ£ Test Configuration
- [ ] Validate syntax: `caddy validate --config Caddyfile`
- [ ] Test locally if possible
- [ ] Document configuration options

### 4ï¸âƒ£ Documentation
- [ ] Add configuration comments
- [ ] Create deployment notes
- [ ] Document customization options

---

## Acceptance Criteria

### Functional Requirements
- [ ] Caddyfile created
- [ ] Reverse proxy configured (:80/:443 â†’ :8000)
- [ ] Automatic HTTPS enabled
- [ ] Rate limiting configured
- [ ] Logging configured
- [ ] Error pages configured
- [ ] Syntax validated

### Configuration Features
- [ ] Domain/hostname configuration
- [ ] HTTPS with automatic certificates
- [ ] Proxy to FastAPI on localhost:8000
- [ ] Request/response headers
- [ ] Rate limiting (optional)
- [ ] Access logging
- [ ] Error handling

---

## Implementation Notes

### Example Caddyfile

**Basic Configuration:**
```caddyfile
# Caddyfile - Neo4j API Reverse Proxy Configuration
# ====================================================
# This configuration proxies HTTP/HTTPS traffic to the FastAPI application
# running on localhost:8000

# Replace with your domain or use :80 for IP-based access
your-domain.com {
    # Automatic HTTPS with Let's Encrypt
    # Caddy automatically obtains and renews certificates

    # Reverse proxy to FastAPI
    reverse_proxy localhost:8000 {
        # Health check endpoint
        health_uri /api/health
        health_interval 30s
        health_timeout 5s

        # Headers
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    # Logging
    log {
        output file /var/log/caddy/neo4j-api.log
        format json
    }

    # Error handling
    handle_errors {
        respond "Service temporarily unavailable" 503
    }
}
```

**Advanced Configuration with Rate Limiting:**
```caddyfile
your-domain.com {
    # Rate limiting (requires caddy-ratelimit plugin)
    # Uncomment if plugin installed:
    # rate_limit {
    #     zone api_limit {
    #         key {remote_host}
    #         events 100
    #         window 1m
    #     }
    # }

    # API endpoints
    reverse_proxy localhost:8000 {
        health_uri /api/health
        health_interval 30s
        health_timeout 5s

        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}

        # Timeouts
        transport http {
            dial_timeout 10s
            response_header_timeout 30s
        }
    }

    # Security headers
    header {
        # Enable HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        # Prevent MIME sniffing
        X-Content-Type-Options "nosniff"
        # Prevent clickjacking
        X-Frame-Options "DENY"
        # XSS protection
        X-XSS-Protection "1; mode=block"
        # Remove server header
        -Server
    }

    # Logging
    log {
        output file /var/log/caddy/neo4j-api-access.log {
            roll_size 100mb
            roll_keep 10
        }
        format json {
            time_format "iso8601"
        }
    }

    # Error pages
    handle_errors {
        @5xx expression {http.error.status_code} >= 500
        handle @5xx {
            respond "Service temporarily unavailable. Please try again later." 503
        }

        @4xx expression {http.error.status_code} >= 400 && {http.error.status_code} < 500
        handle @4xx {
            respond "Bad request" 400
        }
    }
}
```

**Development/Testing (IP-based):**
```caddyfile
# For development/testing without domain
:80 {
    reverse_proxy localhost:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
    }

    log {
        output stdout
    }
}
```

### Configuration Options

**1. Domain Configuration:**
- Replace `your-domain.com` with actual domain
- Use `:80` for IP-based access (no HTTPS)
- Use `:443` for explicit HTTPS on IP

**2. HTTPS/TLS:**
- Automatic with domain name (Let's Encrypt)
- Manual certificates: `tls /path/to/cert.pem /path/to/key.pem`
- Self-signed for testing: `tls internal`

**3. Health Checks:**
- `health_uri` - Endpoint for health checks
- `health_interval` - Check frequency
- `health_timeout` - Check timeout

**4. Headers:**
- `header_up` - Modify request headers to backend
- `header` - Modify response headers to client
- Security headers improve protection

**5. Logging:**
- `output file` - Log to file
- `output stdout` - Log to console
- `format json` - JSON structured logs

**6. Rate Limiting:**
- Requires `caddy-ratelimit` plugin
- Configure per-IP limits
- Prevents API abuse

### File Locations

**Production:**
```bash
/etc/caddy/Caddyfile          # Main configuration
/var/log/caddy/               # Log directory
/var/lib/caddy/               # Certificate storage
```

**Development:**
```bash
./Caddyfile                   # Local configuration
./logs/                       # Local logs
```

---

## Git Workflow

```bash
git checkout main && git pull origin main
git checkout -b feature/P4.2-caddyfile-config

# Create Caddyfile
nano Caddyfile

# Add comprehensive configuration
# Add comments and documentation

# Validate syntax
caddy validate --config Caddyfile

# Add to git
git add Caddyfile
git commit -m "feat(P4.2): create Caddyfile for reverse proxy configuration"
git push origin feature/P4.2-caddyfile-config
```

### Create Pull Request

```bash
gh pr create \
  --title "feat: create Caddyfile for reverse proxy" \
  --body "$(cat <<'EOF'
## Summary
- Created Caddyfile for Caddy reverse proxy configuration
- Automatic HTTPS with Let's Encrypt
- Proxies :80/:443 to FastAPI on :8000
- Includes logging and error handling

## Configuration Features
- Reverse proxy to localhost:8000
- Automatic HTTPS certificate management
- Health checks for FastAPI backend
- Security headers
- Structured JSON logging
- Error handling
- Comments and documentation

## Deployment
Place Caddyfile at `/etc/caddy/Caddyfile` on production server.

## Testing
- [x] Syntax validated
- [x] Configuration documented
- [x] Comments added

## Closes
Closes #33

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
EOF
)"
```

---

## Verification Commands

```bash
# Validate syntax
caddy validate --config Caddyfile

# Test configuration (dry run)
caddy run --config Caddyfile --adapter caddyfile

# Format Caddyfile
caddy fmt --overwrite Caddyfile

# Check Caddy version
caddy version
```

---

## References
- **Caddy Documentation:** https://caddyserver.com/docs/
- **Reverse Proxy:** https://caddyserver.com/docs/caddyfile/directives/reverse_proxy
- **TLS/HTTPS:** https://caddyserver.com/docs/automatic-https

---

## Notes
- Caddy automatically handles HTTPS with Let's Encrypt
- No manual certificate management needed
- Rate limiting requires additional plugin
- Configuration can be customized per deployment
- Test locally before production deployment
- Caddy service must be enabled: `systemctl enable caddy`
