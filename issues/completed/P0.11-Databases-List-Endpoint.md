---
**Status:** To Do
**Priority:** P0
**Branch:** `feature/P0.11-Databases-List-Endpoint`
---

## Overview

Implement Databases List Endpoint
**Phase:** 2 - Health Endpoints

Implement `GET /api/databases` endpoint to list all available Neo4j databases. This endpoint is public (no authentication required) and queries `SHOW DATABASES` from Neo4j.

## Related Specifications
- [ ] **Spec file:** `specs/endpoints-health.md` - Section 2 (List Databases)
- [ ] **Spec file:** `specs/data-models.md` - Database list response model

## Related BDD Tests
- [ ] **Feature file:** `features/health.feature`
- [ ] **Scenarios:** "List databases endpoint returns databases", "Databases list includes system database"
- [ ] **Tags:** `@health`, `@database`

## Dependencies
- [ ] Issue P0.5 - Neo4j client
- [ ] Issue P0.9 - FastAPI app
- [ ] Issue P0.10 - Health router exists

---

## TDD Workflow Checklist

### 1️⃣ RED - Write Failing Tests
- [ ] Add to: `tests/test_health.py`
- [ ] Write unit tests for GET /api/databases
  - [ ] Test returns 200 on success
  - [ ] Test returns list of databases
  - [ ] Test response format matches spec
  - [ ] Test no authentication required
  - [ ] Test error handling if query fails
- [ ] Run tests: `pytest tests/test_health.py::test_databases* -v`
- [ ] **Verify tests FAIL** ❌

### 2️⃣ GREEN - Implement Minimum Code
- [ ] Add to: `app/routers/health.py`
- [ ] Implement GET /databases endpoint
  - [ ] Execute SHOW DATABASES query
  - [ ] Parse results
  - [ ] Return database list
- [ ] Add DatabaseListResponse model to app/models.py
- [ ] Run tests: `pytest tests/test_health.py::test_databases* -v`
- [ ] **Verify tests PASS** ✅

### 3️⃣ REFACTOR
- [ ] Run black, ruff, mypy
- [ ] **Verify tests still pass** ✅

### 4️⃣ BDD Validation
- [ ] Run: `behave features/health.feature --tags=@database -v`
- [ ] **Verify BDD scenarios pass** ✅

### 5️⃣ Coverage Check
- [ ] Run coverage: `pytest tests/test_health.py --cov=app.routers.health --cov-report=term-missing`
- [ ] **Verify 100% coverage** ✅

---

## Acceptance Criteria

### Functional Requirements
- [ ] GET /api/databases endpoint implemented
- [ ] Returns 200 status code
- [ ] Returns list of database names
- [ ] Executes SHOW DATABASES query
- [ ] No authentication required
- [ ] Error handling for query failures

### Non-Functional Requirements
- [ ] Unit tests with 100% coverage
- [ ] BDD scenarios pass
- [ ] Type hints, formatting, linting

### Code Quality Gates
- [ ] Pre-commit hooks pass
- [ ] All tests pass
- [ ] Coverage >= 100%

---

## Implementation Notes

### Example Code

**app/models.py additions:**
```python
class DatabaseListResponse(BaseModel):
    """Database list response."""

    databases: list[str] = Field(..., description="List of database names")
```

**app/routers/health.py additions:**
```python
@router.get("/databases", response_model=DatabaseListResponse)
async def list_databases(
    client: Neo4jClient = Depends(get_neo4j_client),
) -> DatabaseListResponse:
    """List all available Neo4j databases.

    This endpoint does NOT require authentication.

    Returns:
        List of database names.

    Raises:
        HTTPException: If database query fails.
    """
    try:
        # Query system database for database list
        results = client.execute_query(
            "SHOW DATABASES",
            database="system"
        )
        databases = [record["name"] for record in results]
        return DatabaseListResponse(databases=databases)
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to retrieve database list: {str(e)}"
        )
```

---

## Git Workflow

```bash
git checkout main
git pull origin main
git checkout -b feature/P0.11-databases-list-endpoint

# TDD cycle
pytest tests/test_health.py::test_databases* -v
# Implement
pytest tests/test_health.py::test_databases* -v

# Quality checks
black app/ tests/
ruff check app/ tests/ --fix
mypy app/

# BDD
behave features/health.feature --tags=@database -v

# Commit
git add app/routers/health.py app/models.py tests/test_health.py
git commit -m "feat(P0.11): implement GET /api/databases endpoint"
git push origin feature/P0.11-databases-list-endpoint
```

---

## Verification Commands

```bash
pytest tests/test_health.py -v
behave features/health.feature -v
curl http://localhost:8000/api/databases
```

---

## References
- **Specification:** `specs/endpoints-health.md` - Section 2
- **BDD Feature:** `features/health.feature`

---

## Notes
- Query must run on "system" database to list all databases
- This endpoint is public (no authentication)
- Used by clients to discover available databases
