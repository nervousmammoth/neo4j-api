---
**Status:** To Do
**Priority:** P0
**Branch:** `feature/P0.9-Fastapi-App-Skeleton`
---

## Overview

Implement FastAPI Application Skeleton
**Phase:** 1 - Core Infrastructure

Implement `app/main.py` with FastAPI application initialization, lifespan management, and configuration. This creates the main application entry point that will host all API routers.

## Related Specifications
- [ ] **Spec file:** `specs/api-overview.md` - Section 3 (Architecture)
- [ ] **Reference:** FastAPI lifespan events documentation

## Related BDD Tests
N/A - Application tested through endpoint tests

## Dependencies
- [ ] Issue P0.4 - Config module
- [ ] Issue P0.5 - Neo4j client
- [ ] Issue P0.7 - Base models

---

## TDD Workflow Checklist

### 1ï¸âƒ£ RED - Write Failing Tests
- [ ] Create test file: `tests/test_main.py`
- [ ] Write unit tests for app creation
  - [ ] Test app instance creation
  - [ ] Test app configuration (title, version, prefix)
  - [ ] Test lifespan startup creates Neo4j client
  - [ ] Test lifespan shutdown closes Neo4j client
  - [ ] Test OpenAPI docs configuration
- [ ] Run tests: `pytest tests/test_main.py -v`
- [ ] **Verify tests FAIL** âŒ

### 2ï¸âƒ£ GREEN - Implement Minimum Code
- [ ] Implement in: `app/main.py`
- [ ] Create FastAPI app instance
- [ ] Implement lifespan context manager
  - [ ] Startup: Create Neo4j client, verify connectivity
  - [ ] Shutdown: Close Neo4j client
- [ ] Configure app metadata
- [ ] Configure OpenAPI docs URLs
- [ ] Run tests: `pytest tests/test_main.py -v`
- [ ] **Verify tests PASS** âœ…

### 3ï¸âƒ£ REFACTOR - Improve Code Quality
- [ ] Run black: `black app/ tests/`
- [ ] Run ruff: `ruff check app/ tests/ --fix`
- [ ] Run mypy: `mypy app/`
- [ ] **Verify tests still pass** âœ…

### 4ï¸âƒ£ BDD Validation (if applicable)
N/A - Will be validated through endpoint tests

### 5ï¸âƒ£ Coverage Check
- [ ] Run coverage: `pytest tests/test_main.py --cov=app.main --cov-report=term-missing`
- [ ] **Verify 100% coverage** âœ…

---

## Acceptance Criteria

### Functional Requirements
- [ ] FastAPI app instance created
- [ ] App configured with title, version, prefix
- [ ] Lifespan management implemented
- [ ] Neo4j client created on startup
- [ ] Neo4j client closed on shutdown
- [ ] OpenAPI docs at /api/docs
- [ ] ReDoc at /api/redoc
- [ ] OpenAPI JSON at /api/openapi.json

### Non-Functional Requirements
- [ ] Unit tests written (TDD approach)
- [ ] 100% code coverage
- [ ] Type hints present (mypy compliant)
- [ ] Code formatted (black)
- [ ] Linting passed (ruff)
- [ ] Documentation (docstrings)

### Code Quality Gates
- [ ] Pre-commit hooks pass
- [ ] All pytest tests pass
- [ ] Coverage >= 100%
- [ ] No mypy errors
- [ ] No ruff warnings

---

## Implementation Notes

### Example Code Structure

```python
"""FastAPI application entry point.

This module contains the FastAPI application instance, lifespan management,
and router registration.
"""

from __future__ import annotations

import logging
from contextlib import asynccontextmanager
from typing import AsyncIterator

from fastapi import FastAPI

from app.config import get_settings
from app.utils.neo4j_client import Neo4jClient

logger = logging.getLogger(__name__)

# Global Neo4j client instance
neo4j_client: Neo4jClient | None = None

@asynccontextmanager
async def lifespan(app: FastAPI) -> AsyncIterator[None]:
    """Manage application lifespan.

    Startup:
        - Create Neo4j client
        - Verify database connectivity

    Shutdown:
        - Close Neo4j client

    Args:
        app: FastAPI application instance.

    Yields:
        None
    """
    global neo4j_client

    # Startup
    settings = get_settings()
    logger.info("Starting Neo4j API application")

    try:
        neo4j_client = Neo4jClient(settings)
        if neo4j_client.verify_connectivity():
            logger.info("Neo4j connectivity verified")
        else:
            logger.warning("Neo4j connectivity check failed")
    except Exception as e:
        logger.error("Failed to initialize Neo4j client: %s", e)
        neo4j_client = None

    yield

    # Shutdown
    logger.info("Shutting down Neo4j API application")
    if neo4j_client:
        neo4j_client.close()
        logger.info("Neo4j client closed")

# Create FastAPI application
settings = get_settings()

app = FastAPI(
    title=settings.api_title,
    version=settings.api_version,
    lifespan=lifespan,
    docs_url=f"{settings.api_prefix}/docs",
    redoc_url=f"{settings.api_prefix}/redoc",
    openapi_url=f"{settings.api_prefix}/openapi.json",
)

def get_neo4j_client() -> Neo4jClient:
    """Get Neo4j client instance.

    Returns:
        Neo4j client instance.

    Raises:
        RuntimeError: If Neo4j client not initialized.
    """
    if neo4j_client is None:
        raise RuntimeError("Neo4j client not initialized")
    return neo4j_client

# Routers will be added in subsequent issues:
# app.include_router(health.router)
# app.include_router(search.router)
# etc.
```

### Testing Strategy

**Unit tests:**
- Test app instance has correct configuration
- Test lifespan startup creates client
- Test lifespan shutdown closes client
- Test get_neo4j_client() returns client
- Test get_neo4j_client() raises if not initialized
- Mock Neo4jClient to avoid real connections

---

## Git Workflow

### Start Issue
```bash
git checkout main
git pull origin main
git checkout -b feature/P0.9-fastapi-app-skeleton
```

### During Development
```bash
# TDD
pytest tests/test_main.py -v  # FAIL
# Implement
pytest tests/test_main.py -v  # PASS

# Refactor
black app/ tests/
ruff check app/ tests/ --fix
mypy app/

# Coverage
pytest tests/test_main.py --cov=app.main --cov-report=term-missing

# Test app starts
python -c "from app.main import app; print('App created:', app.title)"

# Commit
git add app/main.py tests/test_main.py
git commit -m "feat(P0.9): implement FastAPI application skeleton with lifespan"

# Push
git push origin feature/P0.9-fastapi-app-skeleton
```

### Create Pull Request
```bash
gh pr create \
  --title "feat: implement FastAPI application skeleton" \
  --body "$(cat <<'EOF'
## Summary
- Implemented FastAPI application with lifespan management
- Neo4j client initialization on startup
- Clean shutdown handling
- Full test coverage

## Changes
- Created FastAPI app instance with configuration
- Implemented lifespan context manager
- Neo4j client startup and shutdown
- get_neo4j_client() dependency function
- Complete unit test coverage

## Testing
- [x] Unit tests pass (pytest)
- [x] 100% coverage achieved
- [x] Pre-commit hooks pass
- [x] App starts successfully

## Closes
Closes #09

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
EOF
)"
```

### After Merge
```bash
mv issues/P0.9-fastapi-app-skeleton.md issues/completed/
git checkout main
git pull origin main
```

---

## Verification Commands

```bash
# Run unit tests
pytest tests/test_main.py -v

# Run with coverage
pytest tests/test_main.py --cov=app.main --cov-report=term-missing

# Start dev server (after .env configured)
uvicorn app.main:app --reload

# Check OpenAPI docs
curl http://localhost:8000/api/docs
```

---

## References
- **FastAPI Lifespan:** https://fastapi.tiangolo.com/advanced/events/
- **Specification:** `specs/api-overview.md`
- **Implementation Plan:** `IMPLEMENTATION_PLAN.md` - Phase 1

---

## Notes
- Lifespan uses asynccontextmanager for async setup/teardown
- Global neo4j_client is set during lifespan startup
- Routers will be added in subsequent endpoint implementation issues
- The app can start even if Neo4j connection fails (logs warning)
- OpenAPI docs are automatically generated by FastAPI
