#!/usr/bin/env bash
#
# Pre-push hook for neo4j-api
# Runs comprehensive tests before pushing to remote
#
# This hook is called by "git push" after it has checked the remote status,
# but before anything has been pushed. If this script exits with a non-zero
# status nothing will be pushed.
#
# To bypass this hook, use: git push --no-verify

set -e  # Exit on error

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸš€ Running pre-push checks...${NC}\n"

# Function to print section headers
print_section() {
    echo -e "\n${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
}

# Check if virtual environment is activated
if [[ -z "${VIRTUAL_ENV}" ]]; then
    echo -e "${YELLOW}âš ï¸  Warning: Virtual environment not activated${NC}"
    echo -e "${YELLOW}   Attempting to activate venv...${NC}"
    if [ -d "venv/bin" ]; then
        source venv/bin/activate
    elif [ -d ".venv/bin" ]; then
        source .venv/bin/activate
    else
        echo -e "${RED}âŒ Error: No virtual environment found${NC}"
        echo -e "${RED}   Please create a virtual environment: python3 -m venv venv${NC}"
        exit 1
    fi
fi

# Check if app/ directory exists
if [ ! -d "app" ]; then
    echo -e "${YELLOW}âš ï¸  Warning: app/ directory does not exist yet${NC}"
    echo -e "${YELLOW}   Skipping unit tests (no implementation to test)${NC}"
    SKIP_UNIT_TESTS=true
else
    SKIP_UNIT_TESTS=false
fi

# Check if tests/ directory exists
if [ ! -d "tests" ]; then
    echo -e "${YELLOW}âš ï¸  Warning: tests/ directory does not exist yet${NC}"
    echo -e "${YELLOW}   Skipping unit tests (no tests written)${NC}"
    SKIP_UNIT_TESTS=true
fi

# 1. Run unit tests with 100% coverage requirement
if [ "$SKIP_UNIT_TESTS" = false ]; then
    print_section "ğŸ§ª Running Unit Tests with 100% Coverage Requirement"

    if ! pytest tests/ \
        --cov=app \
        --cov-report=term-missing \
        --cov-report=html:htmlcov \
        --cov-fail-under=100 \
        -v; then
        echo -e "\n${RED}âŒ Unit tests failed or coverage is below 100%${NC}"
        echo -e "${RED}   Review the coverage report above${NC}"
        echo -e "${RED}   To see detailed HTML report: open htmlcov/index.html${NC}"
        echo -e "\n${YELLOW}ğŸ’¡ To bypass this check (not recommended): git push --no-verify${NC}"
        exit 1
    fi

    echo -e "\n${GREEN}âœ… Unit tests passed with 100% coverage${NC}"
else
    echo -e "${YELLOW}â­ï¸  Skipping unit tests (implementation not ready)${NC}"
fi

# 2. Run BDD smoke tests
print_section "ğŸ¥’ Running BDD Smoke Tests"

if ! behave features/ --tags=@smoke --no-capture; then
    echo -e "\n${RED}âŒ BDD smoke tests failed${NC}"
    echo -e "${RED}   Review the test output above${NC}"
    echo -e "\n${YELLOW}ğŸ’¡ To bypass this check (not recommended): git push --no-verify${NC}"
    exit 1
fi

echo -e "\n${GREEN}âœ… BDD smoke tests passed${NC}"

# 3. Run full BDD test suite
print_section "ğŸ¥’ Running Full BDD Test Suite"

if ! behave features/ --no-capture; then
    echo -e "\n${RED}âŒ BDD tests failed${NC}"
    echo -e "${RED}   Review the test output above${NC}"
    echo -e "\n${YELLOW}ğŸ’¡ To bypass this check (not recommended): git push --no-verify${NC}"
    exit 1
fi

echo -e "\n${GREEN}âœ… All BDD tests passed${NC}"

# 4. Final summary
echo -e "\n${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}ğŸ‰ All pre-push checks passed!${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
echo -e "${GREEN}âœ“${NC} Unit tests: ${GREEN}PASSED (100% coverage)${NC}"
echo -e "${GREEN}âœ“${NC} BDD smoke tests: ${GREEN}PASSED${NC}"
echo -e "${GREEN}âœ“${NC} BDD full suite: ${GREEN}PASSED${NC}"
echo -e "\n${GREEN}ğŸš¢ Ready to push!${NC}\n"

exit 0
