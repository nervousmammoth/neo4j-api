#!/usr/bin/env bash
#
# Pre-push hook for neo4j-api
# Runs comprehensive tests before pushing to remote
#
# This hook is called by "git push" after it has checked the remote status,
# but before anything has been pushed. If this script exits with a non-zero
# status nothing will be pushed.
#
# To bypass this hook, use: git push --no-verify

set -e  # Exit on error

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üöÄ Running pre-push checks...${NC}\n"

# Function to print section headers
print_section() {
    echo -e "\n${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}\n"
}

# Check for protected markdown files FIRST (before expensive operations)
print_section "üîí Checking for Protected Markdown Files"

# Get the range of commits being pushed
# Format: $remote_sha..$local_sha
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch, check all commits
        range="$local_sha"
    else
        # Existing branch, check new commits
        range="$remote_sha..$local_sha"
    fi

    # Get list of markdown files in commits being pushed
    md_files=$(git diff --name-only --diff-filter=ACM $range 2>/dev/null | grep '\.md$' || true)

    if [ -n "$md_files" ]; then
        echo -e "${BLUE}Found markdown files in commits:${NC}"
        echo "$md_files" | sed 's/^/  /'
        echo ""

        # Filter to only forbidden patterns:
        # - Files in issues/ directory (issue tracking)
        # - Files in .claude/ directory (Claude config)
        # - Files ending with -plan.md (project plans)
        # - Files ending with -summary.md (summaries)
        # BUT allow:
        # - README.md (project documentation)
        # - CLAUDE.md (Claude Code instructions)
        # - Files in specs/ directory (API specifications)
        forbidden_files=$(echo "$md_files" | grep -E '^issues/|^\.claude/|.*-plan\.md$|.*-summary\.md$' | grep -v -E '^README\.md$|^CLAUDE\.md$|^specs/' || true)

        if [ -n "$forbidden_files" ]; then
            echo -e "${RED}‚ùå Push blocked: Protected markdown files detected${NC}\n"
            echo -e "${RED}The following files should remain local-only:${NC}"
            echo "$forbidden_files" | sed 's/^/  /'
            echo ""
            echo -e "${YELLOW}üí° Why? These files are kept local to:${NC}"
            echo -e "${YELLOW}   ‚Ä¢ Keep issue tracking and planning docs local${NC}"
            echo -e "${YELLOW}   ‚Ä¢ Prevent cluttering the remote repository${NC}"
            echo -e "${YELLOW}   ‚Ä¢ Maintain clean git history focused on code${NC}"
            echo -e "${YELLOW}   ‚Ä¢ Keep Claude Code instructions accessible locally${NC}"
            echo ""
            echo -e "${YELLOW}üìù To fix this:${NC}"
            echo -e "${YELLOW}   1. Remove files from the last commit:${NC}"
            echo -e "${YELLOW}      git reset --soft HEAD~1${NC}"
            echo -e "${YELLOW}   2. Unstage the forbidden files:${NC}"
            echo "$forbidden_files" | sed 's/^/      git reset /'
            echo -e "${YELLOW}   3. Commit again without these files${NC}"
            echo -e "${YELLOW}   4. Push again${NC}"
            echo ""
            echo -e "${YELLOW}üîß To bypass this check (NOT recommended): git push --no-verify${NC}"
            exit 1
        fi

        echo -e "${GREEN}‚úÖ All markdown files are allowed${NC}"
    else
        echo -e "${GREEN}‚úÖ No markdown files in commits${NC}"
    fi
done < /dev/stdin

# Check if virtual environment is activated
if [[ -z "${VIRTUAL_ENV}" ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Virtual environment not activated${NC}"
    echo -e "${YELLOW}   Attempting to activate venv...${NC}"
    if [ -d "venv/bin" ]; then
        source venv/bin/activate
    elif [ -d ".venv/bin" ]; then
        source .venv/bin/activate
    else
        echo -e "${RED}‚ùå Error: No virtual environment found${NC}"
        echo -e "${RED}   Please create a virtual environment: python3 -m venv venv${NC}"
        exit 1
    fi
fi

# Check if app/ directory exists
if [ ! -d "app" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: app/ directory does not exist yet${NC}"
    echo -e "${YELLOW}   Skipping unit tests (no implementation to test)${NC}"
    SKIP_UNIT_TESTS=true
else
    SKIP_UNIT_TESTS=false
fi

# Check if tests/ directory exists
if [ ! -d "tests" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: tests/ directory does not exist yet${NC}"
    echo -e "${YELLOW}   Skipping unit tests (no tests written)${NC}"
    SKIP_UNIT_TESTS=true
fi

# 1. Run unit tests with 100% coverage requirement
if [ "$SKIP_UNIT_TESTS" = false ]; then
    print_section "üß™ Running Unit Tests with 100% Coverage Requirement"

    if ! pytest tests/ \
        --cov=app \
        --cov-report=term-missing \
        --cov-report=html:htmlcov \
        --cov-fail-under=100 \
        -v; then
        echo -e "\n${RED}‚ùå Unit tests failed or coverage is below 100%${NC}"
        echo -e "${RED}   Review the coverage report above${NC}"
        echo -e "${RED}   To see detailed HTML report: open htmlcov/index.html${NC}"
        echo -e "\n${YELLOW}üí° To bypass this check (not recommended): git push --no-verify${NC}"
        exit 1
    fi

    echo -e "\n${GREEN}‚úÖ Unit tests passed with 100% coverage${NC}"
else
    echo -e "${YELLOW}‚è≠Ô∏è  Skipping unit tests (implementation not ready)${NC}"
fi

# 2. Run BDD smoke tests
print_section "ü•í Running BDD Smoke Tests"

if ! behave features/ --tags=@smoke --no-capture; then
    echo -e "\n${RED}‚ùå BDD smoke tests failed${NC}"
    echo -e "${RED}   Review the test output above${NC}"
    echo -e "\n${YELLOW}üí° To bypass this check (not recommended): git push --no-verify${NC}"
    exit 1
fi

echo -e "\n${GREEN}‚úÖ BDD smoke tests passed${NC}"

# 3. Run full BDD test suite
print_section "ü•í Running Full BDD Test Suite"

if ! behave features/ --no-capture; then
    echo -e "\n${RED}‚ùå BDD tests failed${NC}"
    echo -e "${RED}   Review the test output above${NC}"
    echo -e "\n${YELLOW}üí° To bypass this check (not recommended): git push --no-verify${NC}"
    exit 1
fi

echo -e "\n${GREEN}‚úÖ All BDD tests passed${NC}"

# 4. Final summary
echo -e "\n${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
echo -e "${GREEN}üéâ All pre-push checks passed!${NC}"
echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}\n"
echo -e "${GREEN}‚úì${NC} Unit tests: ${GREEN}PASSED (100% coverage)${NC}"
echo -e "${GREEN}‚úì${NC} BDD smoke tests: ${GREEN}PASSED${NC}"
echo -e "${GREEN}‚úì${NC} BDD full suite: ${GREEN}PASSED${NC}"
echo -e "\n${GREEN}üö¢ Ready to push!${NC}\n"

exit 0
